<!DOCTYPE html>
<html lang="zh_CN" xmlns:th="http://www.thymeleaf.org"
	xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<link rel="stylesheet" href="/css/list/gm.css">
<link rel="stylesheet" href="/css/form/comment.css">
<link rel="stylesheet" href="/css/workflow/flowChart.css">
<head th:include="include::formHeaderContent"></head>

<body class="windowPage layer-body" th:classappend="${session.theme}">
	
	<form action="" id="operate">
		<div class="layer-box">
			<div id="hideParam">
				<input type="hidden" id="data" th:value="${data}"/>
				<input type="hidden" id="type" name="type"/>
				<input type="hidden" id="objectType" name="objectType" th:value="${objectType}"/>
				<input type="hidden" id="isContinue" name="isContinue"/>
				<input type="hidden" id="speciData" name="speciData" th:value="${speciData}"/>
				<input type="hidden" id="pageTitle" name="pageTitle" th:value="${pageTitle}"/>
				<input type="hidden" id="pageId" name="pageId" th:value="${pageId}"/>
				<input type="hidden" id="objectId" name="objectId" th:value="${objectId}">
				<input type="hidden" id="transitionId" name="transitionId" th:value="${transitionId}">
				<input type="hidden" id="toNodeId" name="toNodeId" th:value="${toNodeId}">
				<input type="hidden" id="currentNodeId" name="currentNodeId" th:value="${currentNodeId}">
				<input type="hidden" id="workflowId" name="workflowId" th:value="${workflowId}">
				<input type="hidden" id="transitionName" name="transitionName" th:value="${transitionName}">
				<input type="hidden" id="transitionType" name="transitionType" th:value="${transitionType}">
				<input type="hidden" id="isCopy" name="isCopy" th:value="${isCopy}">
				<input type="hidden" id="isEdit" name="isEdit" th:value="${isEdit}">
				<input type="hidden" id="hasSave" name="hasSave" th:value="${hasSave}">
				<input type="hidden" id="tabs" name="tabs" th:value="${tabs}">
					
				<input type="hidden" id="relateId" name="relateId" th:value="${relateId}">
				<input type="hidden" id="isDerive" name="isDerive" th:value="${isDerive}">
				<input type="hidden" id="srcObjectId" name="srcObjectId" th:value="${srcObjectId}">
				<input type="hidden" id="srcWorkflowType" name="srcWorkflowType" th:value="${srcWorkflowType}">
				<input type="hidden" id="isDeriveDraft" name="isDeriveDraft" th:value="${isDeriveDraft}">
				<input type="hidden" id="nonce" name="nonce" th:value="${nonce}">
				<input type="hidden" id="belongId" name="belongId" th:value="${belongId}">
				<input type="hidden" id="belongType" name="belongType" th:value="${belongType}">
				
				<input type="hidden" id="errorMsg" name="errorMsg" th:value="${errorMsg}">
				<input type="hidden" id="onlySave" name="onlySave" value="N">
			</div>
			
			<div class="layout-box">
				<div class="layout-left">
					<ul class="page-ul"></ul>
					<div class="formBtn hide">
						<div class="layui-layer-btn layui-submit-btn">
							<input type="submit" class="layui-layer-btn0 btns cp" id="confirmBtn" th:value="确定"/>
							<input type="submit" class="layui-layer-btn0 btns cp" id="submitBtn" th:value="提交" style="display:none;"/>
							<input type="button" class="layui-layer-btn0 btns cp onlySave two" onclick="$('#onlySave').val('Y');customValidate('ONLYSAVE');onlySaveData();" id="saveBtn" value="保存" style="display:none;">
							<a class="layui-layer-btn1 close-btn cp" th:text="#{common.cancel}" onclick="tabReturnBack($(this))"></a>
						</div>
					</div>
				</div>
				<div class="layout-right"></div>
			</div>
		</div>
	</form>
	
	<div th:include="include::formFooterContent"></div>
	<script src="/js/list/jquery.ui.widget.min.js"></script>
	<script src="/js/form/comment.js"></script>
	<script src="/js/list/gm.js"></script>
	<script src="/js/list/list.table.js"></script>
	<script src="/js/list/list.filter.js"></script>
	<script src="/js/base64.js"></script>
	<script th:inline="javascript"> var ctx = [[@{/}]], parentName = [[${param.parentname}]];</script>
	
	<script>
		var objectType = $('#objectType').val();
		$(function() {
			var data = $('#data').val();
			if(!data) {
				$('#confirmBtn').hide();
			}
			initFormList(data);
			initFormControl(objectType);
			controlBtnShowPosition();
			$('.summernote').each(function() {
				$(this).summernote('code', $(this).prev().val());
			});
			
			var hasSave = $('#hasSave').val();
			if(hasSave && hasSave == 'Y') {
				$('#confirmBtn').hide();
				$('#submitBtn, #saveBtn').show();
			}
			
			$("#operate").html5Validate(function() {
				onlySaveData();
			}, {
				validate: function() {
					return customValidate(objectType);
				}
			});
			
			setTimeout(function(){
				if($('.btn-box').height() > 40) {
					$('.layer-box').height($('.layer-box').height() - 40);
				}
			},100);
		});
		
		function onlySaveData() {
			$.ajax({
				cache : true,
				type : "POST",
				url : "/workflow/saveMyWorkflow",
				data : $('#operate').serialize_plus(),// 你的formid
				async : false,
				success : function(data) {
					var tipMsg = '', pageTo = 1, objectType = '', objectId = '', workflowId = '', currentNodeId = '', firstTranId = '';
					if(data.msg) {
						var msgData = eval('('+data.msg+')');
						if(msgData.tipMsg) {
							tipMsg = msgData.tipMsg;
						}
						if(msgData.pageTo) {
							pageTo = msgData.pageTo;
						}
						if(msgData.objectType){
							objectType = msgData.objectType;
						}
						if(msgData.objectId){
							objectId = msgData.objectId;
						}
						if(msgData.workflowId) {
							workflowId = msgData.workflowId;
						}
						if(msgData.currentNodeId) {
							currentNodeId = msgData.currentNodeId;
						}
						if(msgData.firstTranId) {
							firstTranId = msgData.firstTranId;
						}
						if(msgData.toNodeId) {
							toNodeId = msgData.toNodeId;
						}
					}
					if (data.code == 0) {
						if(objectType && objectId) {
							var belongId = $('#belongId').val(), belongType = $('#belongType').val();
							parent.layer.msg(tipMsg);
							if($('#isDerive').val() == 'Y') {
								msgData.srcObjectType = $('#srcWorkflowType').val();
								msgData.srcObjectId = $('#srcObjectId').val();
								disposeTransition(msgData, parentName, tipMsg);
							}else if(pageTo == 2) {
								tabReturnBack('', false, true);
								openEntity(objectType, objectId, parentName);
							}else if(pageTo == 3) {
								tabReturnBack('', false, true);
								intoProcessPage(objectId, objectType, workflowId, currentNodeId, toNodeId, firstTranId, parentName);
							}else {
								if(parentName && parentName[0]) {
									var parentFrame = top.frames[parentName[0]];
									if(parentFrame && typeof parentFrame.returnBackAndReLoad== "function") {
										parentFrame.returnBackAndReLoad(true);
									}else{
										hideLoading();
										returnBackAndReLoad();
									}
								}else{
									hideLoading();
									returnBackAndReLoad();
								}
							}
						}
					} else {
						parent.layer.msg(tipMsg, 1);
					}
					
					hideLoading();
				}
			});
		}
		
		function intoProcessPage(objectId, objectType, workflowId, currentNodeId, toNodeId, tranId, parentName) {
			var url = '/workflow/workflowProcess/'+objectId+'?objectType='+objectType + '&workflowId=' + workflowId + '&currentNodeId=' + currentNodeId + '&toNodeId=' + toNodeId + '&tranId=' + tranId + '&parentname=' + parentName;
			intoIframePage(url, false, objectType);
		}
	</script>
	
</body>
</html>