<!DOCTYPE html>
<html lang="zh_CN" xmlns:th="http://www.thymeleaf.org"
	xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<meta charset="utf-8">
<link rel="stylesheet" href="/css/list/gm.css">
<link rel="stylesheet" href="/css/form/comment.css">
<link rel="stylesheet" href="/css/workflow/flowChart.css">
<style>
	.more-btn .dropdown-menu{
		right:0px;left:auto;
	}
</style>
<head th:include="include::formHeaderContent"></head>

<body class="windowPage layer-body" th:classappend="${session.theme}">
	<form action="" id="operate">
		<div class="layer-box">
			<div id="hideParam">
				<input type="hidden" id="data" th:value="${data}"/>
				<input type="hidden" id="type" name="type"/>
				<input type="hidden" id="objectType" name="objectType" th:value="${objectType}"/>
				<input type="hidden" id="isContinue" name="isContinue"/>
				<input type="hidden" id="speciData" name="speciData" th:value="${speciData}"/>
				<input type="hidden" id="pageTitle" name="pageTitle" th:value="${pageTitle}"/>
				<input type="hidden" id="pageId" name="pageId" th:value="${pageId}"/>
				<input type="hidden" id="objectId" name="objectId" th:value="${objectId}">
				<input type="hidden" id="transitionId" name="transitionId" th:value="${transitionId}">
				<input type="hidden" id="toNodeId" name="toNodeId" th:value="${toNodeId}">
				<input type="hidden" id="currentNodeId" name="currentNodeId" th:value="${currentNodeId}">
				<input type="hidden" id="workflowId" name="workflowId" th:value="${workflowId}">
				<input type="hidden" id="transitionName" name="transitionName" th:value="${transitionName}">
				<input type="hidden" id="isCopy" name="isCopy" th:value="${isCopy}">
				<input type="hidden" id="isEdit" name="isEdit" th:value="${isEdit}">
				<input type="hidden" id="tabs" name="tabs" th:value="${tabs}">
					
				<input type="hidden" id="isDerive" name="isDerive" th:value="${isDerive}">
				<input type="hidden" id="relateId" name="relateId" th:value="${relateId}">
				<input type="hidden" id="srcObjectId" name="srcObjectId" th:value="${srcObjectId}">
				<input type="hidden" id="srcWorkflowType" name="srcWorkflowType" th:value="${srcWorkflowType}">
				<input type="hidden" id="isDeriveDraft" name="isDeriveDraft" th:value="${isDeriveDraft}">
				<input type="hidden" id="nonce" name="nonce" th:value="${nonce}">
				<input type="hidden" id="belongId" name="belongId" th:value="${belongId}">
				<input type="hidden" id="belongType" name="belongType" th:value="${belongType}">
				
				<input type="hidden" id="canUpdateRelate" name="canUpdateRelate" th:value="${canUpdateRelate}">
				<input type="hidden" id="canUpdateFile" name="canUpdateFile" th:value="${canUpdateFile}">
				
				<input type="hidden" id="errorMsg" name="errorMsg" th:value="${errorMsg}">
				<input type="hidden" id="onlySave" name="onlySave" value="N">
				<input type="hidden" id="tableHeightAuto" name="tableHeightAuto" value="Y">
			</div>
			
			<div class="layout-box tabSign">
				<div class="layout-left">
					<ul class="page-ul"></ul>
				</div>
				<div class="layout-right"></div>
			</div>
			
		</div>
	</form>
	<div class="btn-box hide">
		<div class="layui-layer-btn layui-submit-btn"></div>
	</div>
	
	
	<div th:include="include::formFooterContent"></div>
	<script src="/js/list/jquery.ui.widget.min.js"></script>
	<script src="/js/list/gm.js"></script>
	<script src="/js/list/list.table.js"></script>
	<script src="/js/list/list.filter.js"></script>
	<script src="/js/form/comment.js"></script>
	<script src="/js/base64.js"></script>
	<script src="/js/common/jquery.jqprint-0.3.js"></script>
	<script th:inline="javascript"> var ctx = [[@{/}]], parentName = [[${param.parentname}]];</script>
	
	<script>
		var objectType = $('#objectType').val();
		$(function() {
			var errorMsg = $('#errorMsg').val();
			
			getTranBtn();
			var data = $('#data').val();
			initFormList(data, '', errorMsg);
			initFormControl(objectType);
			$('.btn-box').removeClass('hide');
			$('.summernote').each(function() {
				$(this).summernote('code', $(this).prev().val());
			});
			hideLoading();
		});
		
		//进入审批页面
		function intoProcessPage($obj) {
			var objectType = $('#objectType').val();
			var url = '/workflow/workflowProcess/'+$('#objectId').val()+'?objectType='+objectType+ '&workflowId=' + $('#workflowId').val() + '&currentNodeId=' + $('#currentNodeId').val() + '&toNodeId=' + $obj.attr('toNodeId') + '&tranId=' + $obj.attr('tranId') + '&belongId='+$('#belongId').val()+'&belongType='+$('#belongType').val()+'&parentname=' + parentName;
			intoIframePage(url, false, objectType);
		}
		
		//获取操作按钮
		function getTranBtn() {
			var objectId = $('#objectId').val(), objectType = $('#objectType').val();
			$.ajax({
				cache : true,
				type : "POST",
				url : "/workflow/getLoadData",
				data : {'objectId': objectId, 'objectType': objectType, 'currentNodeId': $('#currentNodeId').val()},
				async : false,
				success : function(data) {
					var html = '';
					if(data) {
						for(var i =0; i < data.length; i++) {
							html += '<input type="submit" class="layui-layer-btn0 btns cp" tranId="'+data[i].id+'" toNodeId="'+data[i].toNodeId+'" onclick="intoProcessPage($(this));" value="'+data[i].name+'"/>';
						}
					}
					html += getMoreBtn();
					$('.layui-submit-btn').html(html);
					
					setTimeout(function(){
						if($('.btn-box').height() > 40) {
							$('.layer-box').height($('.layer-box').height() - 40);
						}
						
						$('#moreSelect li').click(function(){
							var val = $(this).attr('val');
							if(val == 'TM') {
								transmitWorkflow(objectId, objectType, parentName);
							}else if(val == 'COMM') {//沟通
								communication(objectType, objectId, objectType, parentName);
							}else if(val == 'PRINT') {//打印
								$(".page-ul").jqprint();
							}
						});
					},100);
					hideLoading();
				}
			});
		}
		
		function getMoreBtn() {
			var html = '<div class="more-btn" >';
				html+= '	<span class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">';
				html+= '		<span>更多操作</span>';
				html+= '		<i class="fa fa-ellipsis-h ml5"></i>';
				html+= '	</span>';
				html+= '	<ul class="dropdown-menu dropdown-menu-left" x-placement="bottom-end" id="moreSelect">';
				html+= '		<li val="PRINT" title="打印" ><a href="javascript:void(0);">打印</a></li>';
				html+= '		<li val="TM" title="转发" ><a href="javascript:void(0);">转发</a></li>';
				html+= '		<li val="COMM" title="沟通" ><a href="javascript:void(0);">沟通</a></li>';
				html+= '	</ul>';
				html+= '</div>';
			return html;
		}
	</script>
	
</body>
</html>